/*
 * RightsPanel.java
 *
 * Created on 25 July 2008, 17:36
 */

package com.cosmos.acacia.crm.gui.users;

import java.awt.event.ItemEvent;
import java.awt.event.ItemListener;
import java.math.BigInteger;
import java.util.List;

import org.jdesktop.beansbinding.BindingGroup;
import org.jdesktop.swingx.autocomplete.AutoCompleteDecorator;

import com.cosmos.acacia.crm.bl.users.UserRightsRemote;
import com.cosmos.acacia.crm.data.DataObjectBean;
import com.cosmos.acacia.crm.data.DataObjectType;
import com.cosmos.acacia.crm.data.Right;
import com.cosmos.acacia.crm.data.UserRight;
import com.cosmos.acacia.crm.gui.DataObjectTypesListPanel;
import com.cosmos.acacia.gui.AcaciaToStringConverter;
import com.cosmos.acacia.gui.BaseEntityPanel;
import com.cosmos.acacia.gui.EntityFormButtonPanel;
import com.cosmos.acacia.util.AcaciaUtils;
import com.cosmos.beansbinding.EntityProperties;
import com.cosmos.swingb.DialogResponse;
import java.util.Date;

/**
 *
 * @author  Bozhidar Bozhanov
 */
public class RightsPanel extends BaseEntityPanel {

    /** Creates new form RightsPanel */
    public RightsPanel(Right right) {
        super((BigInteger) null);
        this.right = right;
        init();
    }

    @Override
    protected void init()
    {
        initComponents();
        super.init();
    }

    /** This method is called from within the constructor to
     * initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is
     * always regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        dataObjectTypeLabel = new com.cosmos.swingb.JBLabel();
        dataObjectLabel = new com.cosmos.swingb.JBLabel();
        readCheckBox = new com.cosmos.swingb.JBCheckBox();
        createCheckBox = new com.cosmos.swingb.JBCheckBox();
        modifyCheckBox = new com.cosmos.swingb.JBCheckBox();
        deleteCheckBox = new com.cosmos.swingb.JBCheckBox();
        entityFormButtonPanel = new com.cosmos.acacia.gui.EntityFormButtonPanel();
        dataObjectTypeComboBox = new com.cosmos.acacia.gui.AcaciaComboBox();
        dataObjectComboBox = new com.cosmos.acacia.gui.AcaciaComboBox();
        excludedCheckBox = new com.cosmos.swingb.JBCheckBox();
        expiresDatePicker = new com.cosmos.swingb.JBDatePicker();
        expiresLabel = new com.cosmos.swingb.JBLabel();
        executeCheckBox = new com.cosmos.swingb.JBCheckBox();

        setName("Form"); // NOI18N

        org.jdesktop.application.ResourceMap resourceMap = org.jdesktop.application.Application.getInstance(com.cosmos.acacia.crm.gui.AcaciaApplication.class).getContext().getResourceMap(RightsPanel.class);
        dataObjectTypeLabel.setText(resourceMap.getString("dataObjectTypeLabel.text")); // NOI18N
        dataObjectTypeLabel.setName("dataObjectTypeLabel"); // NOI18N

        dataObjectLabel.setText(resourceMap.getString("dataObjectLabel.text")); // NOI18N
        dataObjectLabel.setName("dataObjectLabel"); // NOI18N

        readCheckBox.setText(resourceMap.getString("readCheckBox.text")); // NOI18N
        readCheckBox.setName("readCheckBox"); // NOI18N

        createCheckBox.setText(resourceMap.getString("createCheckBox.text")); // NOI18N
        createCheckBox.setName("createCheckBox"); // NOI18N

        modifyCheckBox.setText(resourceMap.getString("modifyCheckBox.text")); // NOI18N
        modifyCheckBox.setName("modifyCheckBox"); // NOI18N

        deleteCheckBox.setText(resourceMap.getString("deleteCheckBox.text")); // NOI18N
        deleteCheckBox.setName("deleteCheckBox"); // NOI18N

        entityFormButtonPanel.setName("entityFormButtonPanel"); // NOI18N

        dataObjectTypeComboBox.setName("dataObjectTypeComboBox"); // NOI18N

        dataObjectComboBox.setName("dataObjectComboBox"); // NOI18N

        excludedCheckBox.setText(resourceMap.getString("excludedCheckBox.text")); // NOI18N
        excludedCheckBox.setName("excludedCheckBox"); // NOI18N

        expiresDatePicker.setName("expiresDatePicker"); // NOI18N

        expiresLabel.setText(resourceMap.getString("expiresLabel.text")); // NOI18N
        expiresLabel.setName("expiresLabel"); // NOI18N

        executeCheckBox.setText(resourceMap.getString("executeCheckBox.text")); // NOI18N
        executeCheckBox.setName("executeCheckBox"); // NOI18N

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(this);
        this.setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(layout.createSequentialGroup()
                        .addContainerGap()
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addComponent(dataObjectLabel, javax.swing.GroupLayout.Alignment.TRAILING, javax.swing.GroupLayout.DEFAULT_SIZE, 75, Short.MAX_VALUE)
                            .addComponent(dataObjectTypeLabel, javax.swing.GroupLayout.Alignment.TRAILING, javax.swing.GroupLayout.DEFAULT_SIZE, 75, Short.MAX_VALUE)
                            .addComponent(expiresLabel, javax.swing.GroupLayout.Alignment.TRAILING, javax.swing.GroupLayout.DEFAULT_SIZE, 75, Short.MAX_VALUE)
                            .addGroup(layout.createSequentialGroup()
                                .addComponent(readCheckBox, javax.swing.GroupLayout.DEFAULT_SIZE, 75, Short.MAX_VALUE)
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)))
                        .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                            .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, layout.createSequentialGroup()
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING, false)
                                    .addComponent(dataObjectComboBox, javax.swing.GroupLayout.Alignment.TRAILING, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                                    .addComponent(dataObjectTypeComboBox, javax.swing.GroupLayout.Alignment.TRAILING, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                                    .addComponent(expiresDatePicker, javax.swing.GroupLayout.Alignment.TRAILING, javax.swing.GroupLayout.PREFERRED_SIZE, 314, javax.swing.GroupLayout.PREFERRED_SIZE)))
                            .addGroup(layout.createSequentialGroup()
                                .addGap(4, 4, 4)
                                .addComponent(createCheckBox, javax.swing.GroupLayout.PREFERRED_SIZE, 75, javax.swing.GroupLayout.PREFERRED_SIZE)
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                                .addComponent(modifyCheckBox, javax.swing.GroupLayout.PREFERRED_SIZE, 80, javax.swing.GroupLayout.PREFERRED_SIZE)
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                                .addComponent(deleteCheckBox, javax.swing.GroupLayout.PREFERRED_SIZE, 75, javax.swing.GroupLayout.PREFERRED_SIZE)
                                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                                .addComponent(executeCheckBox, javax.swing.GroupLayout.DEFAULT_SIZE, 84, Short.MAX_VALUE))))
                    .addGroup(layout.createSequentialGroup()
                        .addContainerGap()
                        .addComponent(entityFormButtonPanel, javax.swing.GroupLayout.DEFAULT_SIZE, 393, Short.MAX_VALUE))
                    .addGroup(layout.createSequentialGroup()
                        .addContainerGap()
                        .addComponent(excludedCheckBox, javax.swing.GroupLayout.DEFAULT_SIZE, 397, Short.MAX_VALUE)))
                .addContainerGap())
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addContainerGap()
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(dataObjectTypeLabel, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(dataObjectTypeComboBox, javax.swing.GroupLayout.PREFERRED_SIZE, 20, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING)
                    .addComponent(dataObjectLabel, javax.swing.GroupLayout.PREFERRED_SIZE, 17, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(dataObjectComboBox, javax.swing.GroupLayout.PREFERRED_SIZE, 20, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(createCheckBox, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(executeCheckBox, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(deleteCheckBox, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(modifyCheckBox, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(readCheckBox, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.UNRELATED)
                .addComponent(excludedCheckBox, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                .addGroup(layout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(expiresLabel, javax.swing.GroupLayout.PREFERRED_SIZE, 17, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(expiresDatePicker, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(entityFormButtonPanel, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addContainerGap())
        );
    }// </editor-fold>//GEN-END:initComponents

    // Variables declaration - do not modify//GEN-BEGIN:variables
    private com.cosmos.swingb.JBCheckBox createCheckBox;
    private com.cosmos.acacia.gui.AcaciaComboBox dataObjectComboBox;
    private com.cosmos.swingb.JBLabel dataObjectLabel;
    private com.cosmos.acacia.gui.AcaciaComboBox dataObjectTypeComboBox;
    private com.cosmos.swingb.JBLabel dataObjectTypeLabel;
    private com.cosmos.swingb.JBCheckBox deleteCheckBox;
    private com.cosmos.acacia.gui.EntityFormButtonPanel entityFormButtonPanel;
    private com.cosmos.swingb.JBCheckBox excludedCheckBox;
    private com.cosmos.swingb.JBCheckBox executeCheckBox;
    private com.cosmos.swingb.JBDatePicker expiresDatePicker;
    private com.cosmos.swingb.JBLabel expiresLabel;
    private com.cosmos.swingb.JBCheckBox modifyCheckBox;
    private com.cosmos.swingb.JBCheckBox readCheckBox;
    // End of variables declaration//GEN-END:variables


    private UserRightsRemote formSession;
    private Right right;
    private BindingGroup bindingGroup;

    @Override
    protected void initData() {

        BindingGroup bg = getBindingGroup();
        EntityProperties entityProps = getFormSession().getUserRightEntityProperties();

        AcaciaToStringConverter converter = new AcaciaToStringConverter("${dataObjectType}");
        dataObjectTypeComboBox.bind(bg,
                getDataObjectTypes(),
                right,
                entityProps.getPropertyDetails("dataObjectType"),
                converter);
        AutoCompleteDecorator.decorate(dataObjectTypeComboBox, converter);

        readCheckBox.bind(bg, right, entityProps.getPropertyDetails("read"));
        createCheckBox.bind(bg, right, entityProps.getPropertyDetails("create"));
        modifyCheckBox.bind(bg, right, entityProps.getPropertyDetails("modify"));
        deleteCheckBox.bind(bg, right, entityProps.getPropertyDetails("delete"));
        executeCheckBox.bind(bg, right, entityProps.getPropertyDetails("execute"));

        excludedCheckBox.bind(bg, right, entityProps.getPropertyDetails("excluded"));

        expiresDatePicker.setDate(new Date());
        System.out.println(entityProps.getPropertyDetails("expires"));
        System.out.println("entityProps: " + entityProps);
        expiresDatePicker.bind(bg, right, entityProps.getPropertyDetails("expires"),
                AcaciaUtils.getShortDateFormat());

        bg.bind();

        AcaciaToStringConverter dobConverter = new AcaciaToStringConverter("${info}");
        dataObjectComboBox.setConverter(dobConverter);
        updateDataObjectComboBox((DataObjectType) dataObjectTypeComboBox.getSelectedItem());
        AutoCompleteDecorator.decorate(dataObjectComboBox, dobConverter);

        dataObjectTypeComboBox.addItemListener(new ItemListener() {
            @Override
            public void itemStateChanged(ItemEvent e) {
                if (e.getStateChange() == ItemEvent.SELECTED) {
                    Object item = e.getItem();
                    if (item instanceof DataObjectType) {
                        updateDataObjectComboBox((DataObjectType) item);
                    }
                }
            }
        });
    }

    private void updateDataObjectComboBox(DataObjectType type) {
        dataObjectComboBox.removeAllItems();
        List<DataObjectBean> dataObjectBeans = getDataObjectBeans(type);

        boolean isPreChosen = false;
        for (DataObjectBean dob : dataObjectBeans) {
            dataObjectComboBox.addItem(dob);

            if (dob.equals(right.getDataObject())) {
                dataObjectComboBox.setSelectedItem(dob);
                isPreChosen = true;
            }
        }

        if (!isPreChosen)
            dataObjectComboBox.setSelectedIndex(-1);

    }

    protected UserRightsRemote getFormSession() {
        if (formSession == null)
            formSession = getBean(UserRightsRemote.class);

        return formSession;
    }

    private List<DataObjectBean> getDataObjectBeans(DataObjectType dataObjectType) {
        List<DataObjectBean> dataObjectBeans =
                            getFormSession().getDataObjectBeans(dataObjectType);

        return dataObjectBeans;
    }

    private List<DataObjectType> getDataObjectTypes() {
        return DataObjectTypesListPanel.shortenDataObjectTypeNames(getFormSession().getDataObjectTypes());
    }

    @Override
    public BindingGroup getBindingGroup() {
        if(bindingGroup == null) {
            bindingGroup = new BindingGroup();
        }

        return bindingGroup;
    }

    @Override
    public EntityFormButtonPanel getButtonPanel() {
        return entityFormButtonPanel;
    }

    @Override
    public Object getEntity() {
        return right;
    }

    @Override
    public void performSave(boolean closeAfter) {
        DataObjectBean dob = (DataObjectBean) dataObjectComboBox.getSelectedItem();
        if (dob != null) {
            right.setDataObject(dob.getDataObject());
            right.setObjectInfo(dob.getInfo());
        }

        setSelectedValue(right);
        setDialogResponse(DialogResponse.SAVE);
        close();
    }

}