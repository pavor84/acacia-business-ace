/*
 * CustomerDiscountItemForm.java
 *
 * Created on Петък, 2009, Януари 9, 18:56
 */

package com.cosmos.acacia.crm.gui.pricing;

import static com.cosmos.acacia.util.AcaciaUtils.getDecimalFormat;

import java.awt.event.ItemEvent;
import java.awt.event.ItemListener;
import java.io.Serializable;
import java.math.BigDecimal;
import java.math.MathContext;
import java.text.MessageFormat;
import java.util.Arrays;

import org.jdesktop.beansbinding.AbstractBindingListener;
import org.jdesktop.beansbinding.Binding;
import org.jdesktop.beansbinding.BindingGroup;
import org.jdesktop.beansbinding.PropertyStateEvent;
import org.jdesktop.beansbinding.AutoBinding.UpdateStrategy;
import org.jdesktop.swingx.combobox.ListComboBoxModel;

import com.cosmos.acacia.crm.bl.impl.BaseRemote;
import com.cosmos.acacia.crm.bl.pricing.CustomerDiscountRemote;
import com.cosmos.acacia.crm.data.CustomerDiscount;
import com.cosmos.acacia.crm.data.CustomerDiscountItem;
import com.cosmos.acacia.crm.gui.BaseItemForm;
import com.cosmos.acacia.crm.gui.ProductCategoriesTreePanel;
import com.cosmos.acacia.crm.gui.ProductsListPanel;
import com.cosmos.acacia.gui.EntityFormButtonPanel;
import com.cosmos.beansbinding.EntityProperties;
import com.cosmos.swingb.JBFormattedTextField;

/**
 * 
 * Created	:	18.01.2009
 * @author	Petar Milev
 *
 */
public class CustomerDiscountItemForm extends BaseItemForm<CustomerDiscount, CustomerDiscountItem>{

    private boolean forProduct;
    
    public CustomerDiscountItemForm(CustomerDiscountItem entity, CustomerDiscount parent, boolean forProduct) {
        super(entity, parent);
        this.forProduct = forProduct;
        initialize();
    }
    /** This method is called from within the constructor to
     * initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is
     * always regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        entityFormButtonPanel1 = new com.cosmos.acacia.gui.EntityFormButtonPanel();
        productVersionPanel = new com.cosmos.swingb.JBPanel();
        jBLabel2 = new com.cosmos.swingb.JBLabel();
        jBLabel4 = new com.cosmos.swingb.JBLabel();
        jBLabel6 = new com.cosmos.swingb.JBLabel();
        jBLabel1 = new com.cosmos.swingb.JBLabel();
        discountProductField = new com.cosmos.swingb.JBFormattedTextField();
        defaultDiscountLabel = new com.cosmos.swingb.JBLabel();
        salePriceField = new com.cosmos.swingb.JBTextField();
        productField = new com.cosmos.acacia.gui.AcaciaComboList();
        priceField = new com.cosmos.swingb.JBTextField();
        categoryVersionPanel = new com.cosmos.swingb.JBPanel();
        jBLabel3 = new com.cosmos.swingb.JBLabel();
        jBLabel5 = new com.cosmos.swingb.JBLabel();
        jBLabel9 = new com.cosmos.swingb.JBLabel();
        includeHeirs = new com.cosmos.swingb.JBCheckBox();
        categoryField = new com.cosmos.acacia.gui.AcaciaComboList();
        discountCategoryField = new com.cosmos.swingb.JBFormattedTextField();

        setName("Form"); // NOI18N

        entityFormButtonPanel1.setName("entityFormButtonPanel1"); // NOI18N

        productVersionPanel.setName("productVersionPanel"); // NOI18N

        org.jdesktop.application.ResourceMap resourceMap = org.jdesktop.application.Application.getInstance(com.cosmos.acacia.crm.gui.AcaciaApplication.class).getContext().getResourceMap(CustomerDiscountItemForm.class);
        jBLabel2.setText(resourceMap.getString("jBLabel2.text")); // NOI18N
        jBLabel2.setName("jBLabel2"); // NOI18N

        jBLabel4.setText(resourceMap.getString("jBLabel4.text")); // NOI18N
        jBLabel4.setName("jBLabel4"); // NOI18N

        jBLabel6.setText(resourceMap.getString("jBLabel6.text")); // NOI18N
        jBLabel6.setName("jBLabel6"); // NOI18N

        jBLabel1.setText(resourceMap.getString("jBLabel1.text")); // NOI18N
        jBLabel1.setName("jBLabel1"); // NOI18N

        discountProductField.setName("discountProductField"); // NOI18N

        defaultDiscountLabel.setHorizontalAlignment(javax.swing.SwingConstants.TRAILING);
        defaultDiscountLabel.setText(resourceMap.getString("defaultDiscountLabel.text")); // NOI18N
        defaultDiscountLabel.setName("defaultDiscountLabel"); // NOI18N

        salePriceField.setEditable(false);
        salePriceField.setName("salePriceField"); // NOI18N

        productField.setName("productField"); // NOI18N

        priceField.setEditable(false);
        priceField.setName("priceField"); // NOI18N

        javax.swing.GroupLayout productVersionPanelLayout = new javax.swing.GroupLayout(productVersionPanel);
        productVersionPanel.setLayout(productVersionPanelLayout);
        productVersionPanelLayout.setHorizontalGroup(
            productVersionPanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(productVersionPanelLayout.createSequentialGroup()
                .addContainerGap()
                .addGroup(productVersionPanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(jBLabel1, javax.swing.GroupLayout.DEFAULT_SIZE, 155, Short.MAX_VALUE)
                    .addComponent(jBLabel6, javax.swing.GroupLayout.DEFAULT_SIZE, 155, Short.MAX_VALUE)
                    .addComponent(jBLabel4, javax.swing.GroupLayout.DEFAULT_SIZE, 155, Short.MAX_VALUE)
                    .addComponent(jBLabel2, javax.swing.GroupLayout.DEFAULT_SIZE, 155, Short.MAX_VALUE))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(productVersionPanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addGroup(productVersionPanelLayout.createSequentialGroup()
                        .addComponent(discountProductField, javax.swing.GroupLayout.DEFAULT_SIZE, 160, Short.MAX_VALUE)
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                        .addComponent(defaultDiscountLabel, javax.swing.GroupLayout.DEFAULT_SIZE, 133, Short.MAX_VALUE))
                    .addComponent(salePriceField, javax.swing.GroupLayout.DEFAULT_SIZE, 297, Short.MAX_VALUE)
                    .addComponent(productField, javax.swing.GroupLayout.DEFAULT_SIZE, 297, Short.MAX_VALUE)
                    .addComponent(priceField, javax.swing.GroupLayout.DEFAULT_SIZE, 297, Short.MAX_VALUE))
                .addContainerGap())
        );
        productVersionPanelLayout.setVerticalGroup(
            productVersionPanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(productVersionPanelLayout.createSequentialGroup()
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                .addGroup(productVersionPanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(jBLabel1, javax.swing.GroupLayout.PREFERRED_SIZE, 25, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(productField, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(productVersionPanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(salePriceField, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(jBLabel2, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(productVersionPanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(discountProductField, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(defaultDiscountLabel, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(jBLabel4, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(productVersionPanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(priceField, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(jBLabel6, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)))
        );

        categoryVersionPanel.setName("categoryVersionPanel"); // NOI18N

        jBLabel3.setText(resourceMap.getString("jBLabel3.text")); // NOI18N
        jBLabel3.setName("jBLabel3"); // NOI18N

        jBLabel5.setText(resourceMap.getString("jBLabel5.text")); // NOI18N
        jBLabel5.setName("jBLabel5"); // NOI18N

        jBLabel9.setText(resourceMap.getString("jBLabel9.text")); // NOI18N
        jBLabel9.setName("jBLabel9"); // NOI18N

        includeHeirs.setName("includeHeirs"); // NOI18N

        categoryField.setName("categoryField"); // NOI18N

        discountCategoryField.setName("discountCategoryField"); // NOI18N

        javax.swing.GroupLayout categoryVersionPanelLayout = new javax.swing.GroupLayout(categoryVersionPanel);
        categoryVersionPanel.setLayout(categoryVersionPanelLayout);
        categoryVersionPanelLayout.setHorizontalGroup(
            categoryVersionPanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(categoryVersionPanelLayout.createSequentialGroup()
                .addContainerGap()
                .addGroup(categoryVersionPanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(jBLabel3, javax.swing.GroupLayout.DEFAULT_SIZE, 155, Short.MAX_VALUE)
                    .addComponent(jBLabel5, javax.swing.GroupLayout.DEFAULT_SIZE, 155, Short.MAX_VALUE)
                    .addComponent(jBLabel9, javax.swing.GroupLayout.PREFERRED_SIZE, 155, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(categoryVersionPanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(includeHeirs, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addGroup(javax.swing.GroupLayout.Alignment.TRAILING, categoryVersionPanelLayout.createSequentialGroup()
                        .addGroup(categoryVersionPanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING)
                            .addComponent(discountCategoryField, javax.swing.GroupLayout.Alignment.LEADING, javax.swing.GroupLayout.DEFAULT_SIZE, 297, Short.MAX_VALUE)
                            .addComponent(categoryField, javax.swing.GroupLayout.DEFAULT_SIZE, 297, Short.MAX_VALUE))
                        .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)))
                .addGap(10, 10, 10))
        );
        categoryVersionPanelLayout.setVerticalGroup(
            categoryVersionPanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(categoryVersionPanelLayout.createSequentialGroup()
                .addContainerGap()
                .addGroup(categoryVersionPanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
                    .addComponent(categoryField, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                    .addComponent(jBLabel9, javax.swing.GroupLayout.DEFAULT_SIZE, 25, Short.MAX_VALUE))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(categoryVersionPanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING, false)
                    .addComponent(jBLabel5, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
                    .addComponent(includeHeirs, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addGroup(categoryVersionPanelLayout.createParallelGroup(javax.swing.GroupLayout.Alignment.BASELINE)
                    .addComponent(jBLabel3, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(discountCategoryField, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)))
        );

        javax.swing.GroupLayout layout = new javax.swing.GroupLayout(this);
        this.setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addComponent(productVersionPanel, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
            .addComponent(entityFormButtonPanel1, javax.swing.GroupLayout.DEFAULT_SIZE, 476, Short.MAX_VALUE)
            .addComponent(categoryVersionPanel, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE)
        );
        layout.setVerticalGroup(
            layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(layout.createSequentialGroup()
                .addComponent(productVersionPanel, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(categoryVersionPanel, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED)
                .addComponent(entityFormButtonPanel1, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addContainerGap(javax.swing.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE))
        );
    }// </editor-fold>//GEN-END:initComponents


    // Variables declaration - do not modify//GEN-BEGIN:variables
    private com.cosmos.acacia.gui.AcaciaComboList categoryField;
    private com.cosmos.swingb.JBPanel categoryVersionPanel;
    private com.cosmos.swingb.JBLabel defaultDiscountLabel;
    private com.cosmos.swingb.JBFormattedTextField discountCategoryField;
    private com.cosmos.swingb.JBFormattedTextField discountProductField;
    private com.cosmos.acacia.gui.EntityFormButtonPanel entityFormButtonPanel1;
    private com.cosmos.swingb.JBCheckBox includeHeirs;
    private com.cosmos.swingb.JBLabel jBLabel1;
    private com.cosmos.swingb.JBLabel jBLabel2;
    private com.cosmos.swingb.JBLabel jBLabel3;
    private com.cosmos.swingb.JBLabel jBLabel4;
    private com.cosmos.swingb.JBLabel jBLabel5;
    private com.cosmos.swingb.JBLabel jBLabel6;
    private com.cosmos.swingb.JBLabel jBLabel9;
    private com.cosmos.swingb.JBTextField priceField;
    private com.cosmos.acacia.gui.AcaciaComboList productField;
    private com.cosmos.swingb.JBPanel productVersionPanel;
    private com.cosmos.swingb.JBTextField salePriceField;
    private boolean bound;
    // End of variables declaration//GEN-END:variables
    @Override
    protected void bindComponents(BindingGroup bindGroup, EntityProperties entProps) {
        if ( forProduct ){
            // product
            if ( entity.getProduct()==null ){
                ProductsListPanel productList = new ProductsListPanel(getOrganizationDataObjectId());
                productField.bind(
                    bindGroup, 
                    productList,
                    entity,
                    getDetails("product"),
                    "${productName}",
                    UpdateStrategy.READ_WRITE);
                productField.addItemListener(new ItemListener() {
                    public void itemStateChanged(ItemEvent e) {
                        onProduct();
                    }
                }, true);
            }else{
                productField.getComboBox().setModel(new ListComboBoxModel(Arrays.asList(new Serializable(){
                    @Override
                    public String toString() {
                        return entity.getProduct().getProductDisplay();
                    }
                })));
                productField.getComboBox().setSelectedIndex(0);
                productField.setEnabled(false);
            }
            
            // discount
            discountProductField.bind(bindGroup, entity, entProps.getPropertyDetails("discountPercent"), getDecimalFormat());
            discountProductField.getBinding().addBindingListener(new AbstractBindingListener() {
                public void targetChanged(Binding binding, PropertyStateEvent event) {
                    onDiscount();
                }
            });
        }else{
            // category
            if ( entity.getCategory()==null ){
                ProductCategoriesTreePanel categoriesPanel = new ProductCategoriesTreePanel(getOrganizationDataObjectId());
                categoryField.bind(bindGroup, categoriesPanel, entity, getDetails("category"));
                categoryField.addItemListener(new ItemListener() {
                    public void itemStateChanged(ItemEvent e) {
                        onCategory();
                    }
                }, true);
            }else{
                categoryField.getComboBox().setModel(new ListComboBoxModel(Arrays.asList(new Serializable(){
                    @Override
                    public String toString() {
                        return entity.getCategory().getCategoryName();
                    }
                })));
                categoryField.getComboBox().setSelectedIndex(0);
                categoryField.setEnabled(false);
            }
            
            // include heirs
            includeHeirs.bind(bindGroup, entity, entProps.getPropertyDetails("includeHeirs"));
            
            // discount
            discountCategoryField.bind(bindGroup, entity, entProps.getPropertyDetails("discountPercent"), getDecimalFormat());
            discountCategoryField.getBinding().addBindingListener(new AbstractBindingListener() {
                public void targetChanged(Binding binding, PropertyStateEvent event) {
                    onDiscount();
                }
            });
        }
        
        bindGroup.bind();
        bound = true;
        
        afterBind();
    }
    
    protected void onCategory() {
    }
    protected void onProduct() {
        updatePrice();
    }
    protected void onDiscount() {
        updatePrice();
    }
    
    private void updatePrice() {
        if ( !bound )
            return;
        
        if ( entity.getProduct()!=null ){
            // sale price
            String salePrice = "";
            if ( entity.getProduct().getSalePrice()!=null )
                salePrice = getDecimalFormat().format(entity.getProduct().getSalePrice());
            salePriceField.setText((salePrice));
        }else{
            salePriceField.setText("");
        }
        
        if ( !bindGroup.isContentValid() )
            priceField.setText("");
        else{
            if ( entity.getProduct()!=null ){
                // price
                BigDecimal price = getPrice();
                priceField.setText(getDecimalFormat().format(price));
            }else{
                priceField.setText("");
            }
        }
    }
    
    private void afterBind() {
        if ( forProduct ){
            // default discount
            String defaultDiscountString = "0";
            if ( parent.getDiscountPercent()!=null )
                defaultDiscountString = getDecimalFormat().format(parent.getDiscountPercent());
            defaultDiscountLabel.setText(MessageFormat.format(getResourceMap().getString("defaultDiscountLabel.text"), defaultDiscountString));
            
            updatePrice();
        }
    }
    
    private BigDecimal getPrice() {
        //sale price
        BigDecimal salePrice = entity.getProduct().getSalePrice();
        if ( salePrice==null )
            return null;
        
        BigDecimal result = salePrice;
        
        //discount
        BigDecimal discountPercent = entity.getDiscountPercent();
        if (discountPercent==null)
            discountPercent = parent.getDiscountPercent();
        if ( discountPercent!=null ){
            BigDecimal discountPercentDec = discountPercent.divide(new BigDecimal(100), MathContext.DECIMAL64);
            result = result.subtract(result.multiply(discountPercentDec));
        }
        
        return result;
    }
    
    @Override
    protected void initComponentsCustom() {
        categoryVersionPanel.setVisible(!forProduct);
        productVersionPanel.setVisible(forProduct);
        salePriceField.setHorizontalAlignment(JBFormattedTextField.TRAILING);
        priceField.setHorizontalAlignment(JBFormattedTextField.TRAILING);
    }
    
    @Override
    public EntityFormButtonPanel getButtonPanel() {
        return entityFormButtonPanel1;
    }
    @Override
    protected void createComponents() {
        initComponents();
    }
    @Override
    protected Class<? extends BaseRemote<CustomerDiscount, CustomerDiscountItem>> getFormSessionClass() {
        return CustomerDiscountRemote.class;
    }
}
